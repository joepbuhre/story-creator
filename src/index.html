<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css">
  <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>

</head>

<body class="bg-gray-100 p-4">
    <div class="md:w-1/2 mx-auto bg-white p-6 rounded-md shadow-md">
        <form id="apiForm" class="mb-4">
            <label for="url" class="block mb-2 font-bold">URL:</label>
            <input type="text" id="url" name="url" autocomplete="off"
                class="w-full px-4 py-2 mb-4 border rounded-md focus:outline-none focus:ring focus:border-blue-300"
                required>
            <div class="flex">
                <button type="submit"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring focus:border-blue-300 rounded-tr-none rounded-br-none">Make
                    API Call</button>
                <button type="submit" onclick="dieandrestart()"
                    class="w-[100px] bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring focus:border-blue-300 rounded-tl-none rounded-bl-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-power">
                        <path d="M12 2v10" />
                        <path d="M18.4 6.6a9 9 0 1 1-12.77.04" />
                    </svg></button>
        </form>
    </div>
    <div id="chapterResult">
        <div class="buttons">
            <button id="del" class="py-1 px-2 bg-blue-100 rounded-md my-1">Delete</button>
            <button id="add" class="py-1 px-2 bg-blue-100 rounded-md my-1">Add</button>
            <button id="create" class="py-1 px-2 bg-blue-100 rounded-md my-1">Create chapters</button>
        </div>
        <div id="tbl"></div>
    </div>
    <div id="logResult" class="">
        <h2 class="text-lg font-bold mb-2">Log Result:</h2>
        <pre id="logText" class="bg-gray-200 p-4 rounded-md overflow-auto text-sm"></pre>
    </div>
    </div>

    <script>
        let hash = undefined

        const createTable = (data) => {
            const table = new Tabulator("#tbl", {
            data,
            layout: "fitColumns",
            height: 360,

            selectableRows: 1,           // select a row for delete
            movableRows: true,           // drag to reorder rows

            columns: [
                { title: "Order", field: "order", editor: "number", width: 30 },
                { title: "Title", field: "title", editor: "input" },
                { title: "Link", field: "link", editor: "input" }
            ],
            });

            document.getElementById("add").onclick = () => {
                const nextId = Math.max(0, ...table.getData().map(r => r.id ?? 0)) + 1;
                table.addRow({ id: nextId, name: "", qty: 0 }, true); // true => add to top
            };

            document.getElementById("del").onclick = () => {
                const row = table.getSelectedRows()[0];
                if (row) row.delete();
            };

            document.getElementById("create").onclick = () => {
                // This reflects edits + the current row order after drag/drop
                createChapters(table.getData());
            };
        }
        
        const getTrace = async () => {
            const url = document.getElementById('url').value;

            // Get trace id 
            try {
                const response = await fetch('/get-trace', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                window.__TRACE__ = data
                wsConnection(data.trace_id)
                hash = data.hash
                console.log(hash)
            } catch (error) {
                console.error('Error:', error);
            }
        }
        document.getElementById('apiForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            await getTrace()
            
            const url = document.getElementById('url').value;            
            
            try {
                const response = await fetch('/post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                
                createTable(data)


            } catch (error) {
                console.error('Error:', error);
            }
        });


        function wsConnection(str) {
            let wssUrl = new URL(window.location)
            wssUrl.pathname = "/websockets"
            wssUrl.protocol = (window.location.protocol === 'https:') ? "wss" : 'ws'
            wssUrl.search = '?trace_id=' + str
            const ws = new WebSocket(
                wssUrl.toString()
            );

            ws.onopen = (ev) => {
                let nd = document.createTextNode(`Starting log output with trace_id = ${str}\n`)
                document.querySelector('#logText').append(nd)
            }

            ws.onmessage = (ev) => {
                let json = JSON.parse(ev.data)
                let nd = document.createTextNode(`[${json.time}] ${json.level.toUpperCase()}: ${json.msg}\n`)
                document.querySelector('#logText').append(nd)
            }

            ws.onclose = (ev) => {
                console.log('closed')
                if (hash !== undefined) {

                    fetch('/' + hash)
                        .then(async res => ({
                            title: res.headers.get('content-disposition').match(/filename="([^"]+)"/)[1],
                            blob: await res.blob()
                        }))
                        .then(blob => {
                            var link = document.createElement("a");
                            link.href = window.URL.createObjectURL(blob.blob);
                            link.download = blob.title; // Specify the desired filename here
                            link.click();
                        });
                } else {
                    console.log('Hash is undefined')
                }
            }
        }

        function dieandrestart() {
            fetch('/die')
        }

        const createChapters = async (data) => {
            await getTrace()

            try {
                const response = await fetch('/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        ...window.__TRACE__,
                        chapters: data
                     })
                });
                const resp = await response.json();

                debugger
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
    </script>
</body>

</html>